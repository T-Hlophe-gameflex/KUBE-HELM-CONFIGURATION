---
- name: Create AWX Schedule for Cloudflare Survey Auto-Updater
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    awx_host: "{{ controller_host | default('localhost:8052') }}"
    survey_updater_template_name: "Cloudflare Survey Auto-Updater"
    main_template_name: "Cloudflare Template"
    
  tasks:
    - name: Create Survey Updater Job Template
      awx.awx.job_template:
        name: "{{ survey_updater_template_name }}"
        description: "Automated survey dropdown updater for Cloudflare templates"
        job_type: run
        inventory: "Demo Inventory"
        project: "{{ project_name | default('KUBE-HELM-CONFIGURATION') }}"
        playbook: "automation/playbooks/cloudflare/scheduled-survey-updater.yml"
        credentials: 
          - "Demo Credential"
        state: present
        controller_host: "{{ awx_host }}"
        controller_username: admin
        controller_password: "{{ awx_admin_password | default(lookup('env', 'AWX_ADMIN_PASSWORD')) }}"
        validate_certs: false
        extra_vars:
          awx_host: "{{ awx_host }}"
          template_id: "21"
        ask_variables_on_launch: false
        ask_inventory_on_launch: false
        ask_credential_on_launch: false
        timeout: 300
        verbosity: 1
      register: survey_template_result
      
    - name: Display template creation result
      debug:
        msg:
          - "Survey Updater Template Status: {{ 'Created' if survey_template_result.changed else 'Already exists' }}"
          - "Template ID: {{ survey_template_result.id | default('N/A') }}"

    - name: Create Hourly Schedule for Survey Updates
      awx.awx.schedule:
        name: "Survey Auto-Update - Hourly"
        description: "Updates Cloudflare survey dropdowns every hour during business hours"
        state: present
        unified_job_template: "{{ survey_updater_template_name }}"
        enabled: true
        rrule: "DTSTART:20251030T080000Z RRULE:FREQ=HOURLY;BYHOUR=8,9,10,11,12,13,14,15,16,17;BYDAY=MO,TU,WE,TH,FR"
        controller_host: "{{ awx_host }}"
        controller_username: admin
        controller_password: "{{ awx_admin_password | default(lookup('env', 'AWX_ADMIN_PASSWORD')) }}"
        validate_certs: false
      register: hourly_schedule_result
      
    - name: Create After-Job Schedule (Manual Trigger)
      awx.awx.schedule:
        name: "Survey Auto-Update - After Main Job"
        description: "Updates survey dropdowns after main Cloudflare template executions"
        state: present
        unified_job_template: "{{ survey_updater_template_name }}"
        enabled: false  # Enable manually when needed
        rrule: "DTSTART:20251030T180000Z RRULE:FREQ=DAILY;INTERVAL=1"  # Daily at 6 PM as fallback
        controller_host: "{{ awx_host }}"
        controller_username: admin
        controller_password: "{{ awx_admin_password | default(lookup('env', 'AWX_ADMIN_PASSWORD')) }}"
        validate_certs: false
      register: daily_schedule_result

    - name: Create Weekly Full Refresh Schedule
      awx.awx.schedule:
        name: "Survey Auto-Update - Weekly Refresh"
        description: "Weekly comprehensive refresh of all survey dropdown data"
        state: present
        unified_job_template: "{{ survey_updater_template_name }}"
        enabled: true
        rrule: "DTSTART:20251030T060000Z RRULE:FREQ=WEEKLY;BYDAY=MO"  # Every Monday at 6 AM
        controller_host: "{{ awx_host }}"
        controller_username: admin
        controller_password: "{{ awx_admin_password | default(lookup('env', 'AWX_ADMIN_PASSWORD')) }}"
        validate_certs: false
      register: weekly_schedule_result

    - name: Display schedule creation results
      debug:
        msg:
          - "════════════════════════════════════════════════════════════"
          - "AWX SURVEY AUTO-UPDATER SCHEDULES CREATED"
          - "════════════════════════════════════════════════════════════"
          - ""
          - "📅 Hourly Schedule:"
          - "   Name: Survey Auto-Update - Hourly"
          - "   Status: {{ 'Created' if hourly_schedule_result.changed else 'Already exists' }}"
          - "   Enabled: Yes"
          - "   Frequency: Every hour, 8 AM - 5 PM, Monday-Friday"
          - ""
          - "📅 Daily Schedule:"
          - "   Name: Survey Auto-Update - After Main Job"
          - "   Status: {{ 'Created' if daily_schedule_result.changed else 'Already exists' }}"
          - "   Enabled: No (manual trigger)"
          - "   Frequency: Daily at 6 PM (fallback)"
          - ""
          - "📅 Weekly Schedule:"
          - "   Name: Survey Auto-Update - Weekly Refresh"
          - "   Status: {{ 'Created' if weekly_schedule_result.changed else 'Already exists' }}"
          - "   Enabled: Yes"
          - "   Frequency: Every Monday at 6 AM"
          - ""
          - "🔧 Management:"
          - "   • Go to AWX → Templates → Schedules to manage"
          - "   • Enable/disable schedules as needed"
          - "   • Monitor execution logs for issues"
          - "   • Adjust frequency based on usage patterns"

    - name: Create workflow template for chained execution
      awx.awx.workflow_job_template:
        name: "Cloudflare DNS + Survey Update Workflow"
        description: "Executes Cloudflare DNS operations followed by survey refresh"
        state: present
        controller_host: "{{ awx_host }}"
        controller_username: admin
        controller_password: "{{ awx_admin_password | default(lookup('env', 'AWX_ADMIN_PASSWORD')) }}"
        validate_certs: false
        ask_variables_on_launch: true
        ask_inventory_on_launch: false
        survey_enabled: true
        survey_spec:
          name: "Cloudflare Workflow Survey"
          description: "Execute Cloudflare operations and update survey"
          spec:
            - question_name: "Auto-update survey after completion"
              variable: "auto_update_survey"
              type: "multiplechoice"
              choices: ["yes", "no"]
              default: "yes"
              required: true
              question_description: "Automatically refresh survey dropdowns after DNS operations"
      register: workflow_result
      ignore_errors: true

    - name: Display workflow creation status
      debug:
        msg:
          - "🔗 Workflow Template: {{ 'Created' if workflow_result.changed else 'Creation attempted' }}"
          - "   This allows chaining DNS operations with survey updates"
          - "   Configure workflow nodes manually in AWX UI"
      when: workflow_result is defined