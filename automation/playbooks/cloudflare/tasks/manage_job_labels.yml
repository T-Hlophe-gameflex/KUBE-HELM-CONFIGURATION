---
# Manage AWX Job Labels Task
# Creates and applies labels to AWX jobs in the format "action:ticket_number"

- name: Create combined action:ticket label
  set_fact:
    combined_label: "{{ cf_action }}:{{ survey_ticket_number | default(ticket_number | default('NO-TICKET')) }}"

- name: Create combined label via API
  uri:
    url: "http://localhost:8080/api/v2/labels/"
    method: POST
    headers:
      Authorization: "Basic {{ (awx_username | default('admin') + ':' + awx_password) | b64encode }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ combined_label }}"
      organization: 1
    return_content: true
    validate_certs: false
    status_code: [200, 201, 400]
  register: combined_label_result
  ignore_errors: true

- name: Apply combined label to current job
  uri:
    url: "http://localhost:8080/api/v2/jobs/{{ tower_job_id }}/labels/"
    method: POST
    headers:
      Authorization: "Basic {{ (awx_username | default('admin') + ':' + awx_password) | b64encode }}"
      Content-Type: "application/json"
    body_format: json
    body:
      id: "{{ combined_label_result.json.id }}"
    validate_certs: false
    status_code: [200, 201, 204, 400]
  register: job_combined_label_apply_result
  when: 
    - tower_job_id is defined
    - combined_label_result is defined
    - combined_label_result.json is defined
    - combined_label_result.json.id is defined
  ignore_errors: true

- name: Create job tags for UI visibility
  set_fact:
    job_tags_list: 
      - "CLOUDFLARE"
      - "{{ combined_label }}"

- name: Set job tags as comma-separated string
  set_fact:
    job_tags_string: "{{ job_tags_list | join(',') }}"

- name: Display job identification tags
  debug:
    msg:
      - "JOB IDENTIFICATION TAGS"
      - "════════════════════════════════════════════════════════════"
      - "Combined Label: {{ combined_label }}"
      - "Platform: CLOUDFLARE"
      - "Full Tags: {{ job_tags_string }}"
      - "════════════════════════════════════════════════════════════"
      - "This combined label shows both action and ticket number"

- name: Display applied labels summary
  debug:
    msg: 
      - "Job Label Applied:"
      - "  Combined: {{ combined_label }}"
