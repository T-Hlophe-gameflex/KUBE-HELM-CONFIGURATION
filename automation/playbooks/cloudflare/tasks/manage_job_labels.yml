---
# Manage AWX Job Labels Task
# Creates and applies labels to AWX jobs based on the action being performed

- name: Determine action label based on cf_action
  set_fact:
    action_label: >-
      {%- if cf_action == 'create_record' -%}
        CREATE
      {%- elif cf_action == 'update_record' -%}
        UPDATE
      {%- elif cf_action == 'delete_record' -%}
        DELETE
      {%- elif cf_action == 'clone_record' -%}
        CLONE
      {%- elif cf_action == 'create_domain' -%}
        CREATE-DOMAIN
      {%- elif cf_action == 'update_settings' -%}
        UPDATE-SETTINGS
      {%- elif cf_action == 'sync' -%}
        SYNC
      {%- else -%}
        {{ cf_action | upper | default('UNKNOWN') }}
      {%- endif -%}

- name: Create action-specific label via API
  uri:
    url: "http://localhost:8052/api/v2/labels/"
    method: POST
    headers:
      Authorization: "Basic {{ (awx_username | default('admin') + ':' + awx_password) | b64encode }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ action_label }}"
      organization: 1
    return_content: true
    validate_certs: false
    status_code: [200, 201, 400]  # 400 if already exists
  register: action_label_result
  ignore_errors: true

- name: Create record type label (if applicable)
  uri:
    url: "http://localhost:8052/api/v2/labels/"
    method: POST
    headers:
      Authorization: "Basic {{ (awx_username | default('admin') + ':' + awx_password) | b64encode }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ record_type | upper }}"
      organization: 1
    return_content: true
    validate_certs: false
    status_code: [200, 201, 400]  # 400 if already exists
  register: type_label_result
  when: 
    - record_type is defined
    - cf_action in ['create_record', 'update_record', 'delete_record', 'clone_record']
  ignore_errors: true

- name: Create domain label
  uri:
    url: "http://localhost:8052/api/v2/labels/"
    method: POST
    headers:
      Authorization: "Basic {{ (awx_username | default('admin') + ':' + awx_password) | b64encode }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ resolved_domain | upper | replace('.', '-') }}"
      organization: 1
    return_content: true
    validate_certs: false
    status_code: [200, 201, 400]  # 400 if already exists
  register: domain_label_result
  when: 
    - resolved_domain is defined
    - resolved_domain | length > 0
    - resolved_domain != 'undefined'
  ignore_errors: true

- name: Display label creation results
  debug:
    msg:
      - "ðŸ“‹ AWX Job Labels Created:"
      - "  Action Label: {{ action_label }} - {{ 'CREATED' if action_label_result.status == 201 else ('EXISTS' if action_label_result.status == 400 else 'UNKNOWN') }}"
      - "  Type Label: {{ record_type | upper | default('N/A') }} - {{ 'CREATED' if type_label_result.status | default(0) == 201 else ('EXISTS' if type_label_result.status | default(0) == 400 else 'SKIPPED') }}"
      - "  Domain Label: {{ resolved_domain | upper | replace('.', '-') | default('N/A') }} - {{ 'CREATED' if domain_label_result.status | default(0) == 201 else ('EXISTS' if domain_label_result.status | default(0) == 400 else 'SKIPPED') }}"