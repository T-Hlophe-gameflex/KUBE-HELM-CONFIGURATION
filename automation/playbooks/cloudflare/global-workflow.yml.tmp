---
- name: Cloudflare Global Workflow
  hosts: localhost
  gather_facts: false
  vars:
    # Prefer the environment variable; passing --extra-vars cloudflare_api_token=... will override this
    cloudflare_api_token: "{{ lookup('env','CLOUDFLARE_API_TOKEN') | default('') | trim }}"
    dry_run: "{{ dry_run | default(true) }}"

  tasks:
    - name: DEBUG: sanitized token
      debug:
        msg: "cloudflare_api_token={{ cloudflare_api_token | default('') | regex_replace('.{4}$','****') }}"

    - name: Announce dry-run
      debug:
        msg: "DRY RUN enabled - no mutating API calls will be made. Set dry_run=false to execute."
      when: dry_run | bool

    - name: Validate token when not dry-run
      fail:
        msg: "CLOUDFLARE_API_TOKEN must be set when dry_run is false."
      when: not (dry_run | bool) and cloudflare_api_token == ''

    - name: Fetch all Cloudflare zones (domains)
      uri:
        validate_certs: false
        url: "https://api.cloudflare.com/client/v4/zones?per_page=50"
        method: GET
        headers:
          Authorization: "Bearer {{ cloudflare_api_token }}"
          Content-Type: "application/json"
        return_content: true
      register: zones_response
      when: not (dry_run | bool)

    - name: DRY RUN: Show planned domain list
      debug:
        msg: "Would fetch zones from Cloudflare and then apply global settings (dry_run enabled)."
      when: dry_run | bool

    - name: Set available domains
      set_fact:
        available_domains: "{{ zones_response.json.result | map(attribute='name') | list }}"
      when: zones_response is defined and zones_response.json.success

    - name: Show discovered domains
      debug:
        var: available_domains
      when: available_domains is defined
