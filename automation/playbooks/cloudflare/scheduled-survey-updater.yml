---
- hosts: localhost
  connection: local
  gather_facts: true
  vars:
    awx_host: "ansible-awx-service.awx.svc.cluster.local"
    awx_port: "80"
    awx_template_id: "21"
    
  tasks:
    - name: Get AWX admin password
      shell: kubectl get secret ansible-awx-admin-password -n awx -o jsonpath="{.data.password}" | base64 --decode
      register: awx_password_result
      no_log: true
      
    - name: Set AWX password
      set_fact:
        awx_password: "{{ awx_password_result.stdout }}"
      no_log: true

    - name: Update Survey Dropdowns - Scheduled Job
      block:
        - name: Display job information
          debug:
            msg:
              - "🕐 AWX Survey Auto-Updater - Scheduled Execution"
              - "   Started: {{ ansible_date_time.iso8601 }}"
              - "   Target AWX: {{ awx_host }}"
              - "   Template ID: {{ awx_template_id }}"
              - "   Purpose: Update survey dropdowns with live Cloudflare data"
              - "   Cloudflare Token Available: {{ 'Yes' if lookup('env','CLOUDFLARE_API_TOKEN') | length > 0 else 'No (using fallback)' }}"
        
        - name: Get current survey configuration
          uri:
            url: "http://{{ awx_host }}/api/v2/job_templates/{{ awx_template_id }}/survey_spec/"
            method: GET
            user: "{{ awx_username }}"
            password: "{{ awx_password }}"
            force_basic_auth: true
            return_content: true
          register: current_survey
          
        - name: Get Cloudflare zones (domains)
          uri:
            url: "https://api.cloudflare.com/client/v4/zones"
            method: GET
            headers:
              Authorization: "Bearer {{ lookup('env','CLOUDFLARE_API_TOKEN') }}"
            return_content: true
          register: cf_zones
          when: lookup('env','CLOUDFLARE_API_TOKEN') | length > 0
          failed_when: false
          
        - name: Extract domain names from zones
          set_fact:
            domain_list: "{{ (cf_zones.json.result | map(attribute='name') | list | sort)[:20] + ['[MANUAL_ENTRY]'] }}"
          when: 
            - cf_zones is defined 
            - cf_zones.json is defined
            - cf_zones.json.success | default(false)
          
        - name: Use fallback domain list if API fails
          set_fact:
            domain_list: 
              - "efustryton.co.za"
              - "efutechnologies.co.za" 
              - "[MANUAL_ENTRY]"
          when: domain_list is not defined
          
        - name: Collect DNS records from all zones
          uri:
            url: "https://api.cloudflare.com/client/v4/zones/{{ item.id }}/dns_records"
            method: GET
            headers:
              Authorization: "Bearer {{ lookup('env','CLOUDFLARE_API_TOKEN') }}"
            return_content: true
          register: dns_records_results
          loop: "{{ cf_zones.json.result | default([]) }}"
          when: 
            - cf_zones is defined 
            - cf_zones.json is defined
            - cf_zones.json.success | default(false)
            - lookup('env','CLOUDFLARE_API_TOKEN') | length > 0
          failed_when: false
          
        - name: Extract unique record names
          set_fact:
            all_record_names: >-
              {{ dns_records_results.results 
                 | selectattr('json', 'defined')
                 | selectattr('json.success', 'equalto', true)
                 | map(attribute='json.result') 
                 | flatten
                 | map(attribute='name')
                 | map('regex_replace', '\.[^.]+\.[^.]+$', '')
                 | select('ne', '@')
                 | unique 
                 | sort
                 | list }}
          when: dns_records_results is defined
          
        - name: Build final record list
          set_fact:
            record_list: "{{ (all_record_names[:50] if all_record_names is defined else []) + ['[NONE]', '[REFRESH_NEEDED]'] }}"
          
        - name: Use fallback record list if needed
          set_fact:
            record_list: ["[NONE]", "[REFRESH_NEEDED]"]
          when: record_list is not defined or record_list | length <= 2
          
        - name: Update survey with new dropdown choices
          set_fact:
            updated_survey: >-
              {{ current_survey.json | combine({
                'spec': current_survey.json.spec | map('combine', {
                  'choices': domain_list
                } if item.variable == 'existing_domain' else (
                  {'choices': record_list} if item.variable == 'existing_record' else {}
                )) | list
              }) }}
          
        - name: Apply updated survey to AWX
          uri:
            url: "http://{{ awx_host }}/api/v2/job_templates/{{ awx_template_id }}/survey_spec/"
            method: POST
            user: "{{ awx_username }}"
            password: "{{ awx_password }}"
            force_basic_auth: true
            body_format: json
            body: "{{ updated_survey }}"
            return_content: true
          register: survey_update_result
          
        - name: Display update results
          debug:
            msg:
              - "✅ Survey dropdowns updated successfully!"
              - "📊 Statistics:"
              - "   • Domains: {{ domain_list | length }} options"
              - "   • Records: {{ record_list | length }} options"
              - "   • Updated at: {{ ansible_date_time.iso8601 }}"
              
      rescue:
        - name: Handle update failures
          debug:
            msg:
              - "❌ Failed to update survey dropdowns"
              - "Error: {{ ansible_failed_result.msg | default('Unknown error') }}"
              - "Continuing with existing survey configuration..."
              
    - name: Job completion summary
      debug:
        msg:
          - "════════════════════════════════════════════════════════════"
          - "AWX Survey Auto-Updater - Job Complete"
          - "Finished: {{ ansible_date_time.iso8601 }}"
          - "Status: {{ 'SUCCESS' if survey_update_result is defined and survey_update_result.json is defined else 'FAILED' }}"
          - "════════════════════════════════════════════════════════════"